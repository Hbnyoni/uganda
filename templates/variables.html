<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Selection - {{ filename }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .variable-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .variable-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .variable-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        .variable-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .variable-item .name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .variable-item .info {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .variable-item .info span {
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Variable Selection</h1>
            <p>Configure spatial interpolation for {{ filename }}</p>
        </div>
        
        <div class="content">
            <a href="/" class="back-link">‚Üê Back to file selection</a>
            
            <div class="section">
                <h3>üìç 1. Select Coordinate Columns</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="lat-column">Latitude Column:</label>
                        <select id="lat-column" required>
                            <option value="">Select latitude column...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lon-column">Longitude Column:</label>
                        <select id="lon-column" required>
                            <option value="">Select longitude column...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>üìä 2. Select Variables to Interpolate</h3>
                <p>Click on the variables you want to interpolate (numeric columns only):</p>
                <div class="variable-list" id="variable-list">
                    <!-- Variables will be loaded here -->
                </div>
                <div id="selected-variables">
                    <strong>Selected variables:</strong> <span id="selected-count">0</span>
                </div>
            </div>
            
            <div class="section">
                <h3>‚öôÔ∏è 3. Interpolation Settings</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="method">Interpolation Method:</label>
                        <select id="method">
                            <option value="kriging">Kriging (Recommended)</option>
                            <option value="idw">Inverse Distance Weighting</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resolution">Grid Resolution:</label>
                        <input type="range" id="resolution" min="50" max="300" value="100" 
                               oninput="document.getElementById('resolution-value').textContent = this.value">
                        <span id="resolution-value">100</span> x <span id="resolution-value2">100</span> grid
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3>üöÄ 4. Run Interpolation</h3>
                <button class="btn btn-success" onclick="runInterpolation()">
                    üó∫Ô∏è Start Spatial Interpolation
                </button>
                <button class="btn btn-warning" onclick="validateConfiguration()">
                    ‚úÖ Validate Configuration
                </button>
            </div>
            
            <div class="loading">
                <div class="spinner"></div>
                <p>Running spatial interpolation... This may take a few minutes.</p>
            </div>
            
            <div class="results">
                <h3>üìã Results:</h3>
                <div id="result-content"></div>
            </div>
        </div>
    </div>
    
    <script>
        let columnData = {};
        let selectedVariables = new Set();
        const filename = '{{ filename }}';
        
        // Load column data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadColumnData();
        });
        
        function loadColumnData() {
            fetch(`/api/variable_selection/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading data: ' + data.error);
                        return;
                    }
                    
                    columnData = data.columns;
                    populateColumnSelectors();
                    populateVariableList();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load column data');
                });
        }
        
        function populateColumnSelectors() {
            const latSelect = document.getElementById('lat-column');
            const lonSelect = document.getElementById('lon-column');
            
            // Clear existing options (keep first placeholder)
            latSelect.innerHTML = '<option value="">Select latitude column...</option>';
            lonSelect.innerHTML = '<option value="">Select longitude column...</option>';
            
            // Add all columns as options
            Object.keys(columnData).forEach(col => {
                const colInfo = columnData[col];
                const option1 = new Option(`${col} (${colInfo.dtype})`, col);
                const option2 = new Option(`${col} (${colInfo.dtype})`, col);
                
                latSelect.appendChild(option1);
                lonSelect.appendChild(option2);
                
                // Auto-select likely coordinate columns
                const colLower = col.toLowerCase();
                if (colInfo.is_numeric) {
                    if (['lat', 'latitude', 'y', 'northing'].some(term => colLower.includes(term))) {
                        latSelect.value = col;
                    }
                    if (['lon', 'lng', 'longitude', 'x', 'easting'].some(term => colLower.includes(term))) {
                        lonSelect.value = col;
                    }
                }\n            });
        }
        
        function populateVariableList() {
            const variableList = document.getElementById('variable-list');
            variableList.innerHTML = '';
            
            // Add numeric columns as selectable variables
            Object.entries(columnData).forEach(([col, info]) => {
                if (info.is_numeric && info.non_null_count >= 10) {
                    const item = document.createElement('div');
                    item.className = 'variable-item';
                    item.onclick = () => toggleVariable(col, item);
                    
                    item.innerHTML = `
                        <div class="name">${col}</div>
                        <div class="info">
                            <span>üìä ${info.non_null_count} points</span>
                            <span>üìâ ${info.null_percentage.toFixed(1)}% missing</span>
                            <span>üìà ${info.min?.toFixed(2)} - ${info.max?.toFixed(2)}</span>
                        </div>
                    `;
                    
                    variableList.appendChild(item);
                }
            });
        }
        
        function toggleVariable(variable, element) {
            if (selectedVariables.has(variable)) {
                selectedVariables.delete(variable);
                element.classList.remove('selected');
            } else {
                selectedVariables.add(variable);
                element.classList.add('selected');
            }
            
            document.getElementById('selected-count').textContent = selectedVariables.size;
            
            // Update resolution display
            const resolution = document.getElementById('resolution').value;
            document.getElementById('resolution-value2').textContent = resolution;
        }
        
        function validateConfiguration() {
            const latCol = document.getElementById('lat-column').value;
            const lonCol = document.getElementById('lon-column').value;
            
            let errors = [];
            
            if (!latCol) errors.push('‚ùå Please select a latitude column');
            if (!lonCol) errors.push('‚ùå Please select a longitude column');
            if (selectedVariables.size === 0) errors.push('‚ùå Please select at least one variable to interpolate');
            if (latCol === lonCol) errors.push('‚ùå Latitude and longitude columns must be different');
            
            if (errors.length > 0) {
                alert(errors.join('\\n'));
                return false;
            }
            
            // Check data quality
            const latInfo = columnData[latCol];
            const lonInfo = columnData[lonCol];
            
            if (latInfo.non_null_count < 10 || lonInfo.non_null_count < 10) {
                errors.push('‚ö†Ô∏è Insufficient coordinate data points (minimum 10 required)');
            }
            
            // Check selected variables
            selectedVariables.forEach(variable => {
                const varInfo = columnData[variable];
                if (varInfo.non_null_count < 10) {
                    errors.push(`‚ö†Ô∏è ${variable}: insufficient data points (${varInfo.non_null_count})`);
                }
            });
            
            if (errors.length > 0) {
                alert('Validation warnings:\\n' + errors.join('\\n') + '\\n\\nContinue anyway?');
            } else {
                alert('‚úÖ Configuration is valid! Ready to run interpolation.');
            }
            
            return errors.length === 0;
        }
        
        function runInterpolation() {
            if (!validateConfiguration()) {
                return;
            }
            
            const config = {
                filename: filename,
                lat_column: document.getElementById('lat-column').value,
                lon_column: document.getElementById('lon-column').value,
                variables: Array.from(selectedVariables),
                method: document.getElementById('method').value,
                resolution: parseInt(document.getElementById('resolution').value)
            };
            
            // Show loading
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.results').style.display = 'none';
            
            fetch('/api/run_interpolation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.results').style.display = 'block';
                
                if (data.error) {
                    document.getElementById('result-content').innerHTML = `
                        <div style="color: red;">
                            <h4>‚ùå Error:</h4>
                            <p>${data.error}</p>
                        </div>
                    `;
                } else {
                    displayResults(data);
                }
            })
            .catch(error => {
                document.querySelector('.loading').style.display = 'none';
                console.error('Error:', error);
                alert('Interpolation failed: ' + error);
            });
        }
        
        function displayResults(data) {
            let html = `
                <h4>‚úÖ Interpolation Completed</h4>
                <p><strong>Method:</strong> ${data.config.method}</p>
                <p><strong>Grid Resolution:</strong> ${data.config.resolution}x${data.config.resolution}</p>
                <p><strong>Output Files:</strong> ${data.output_files.length}</p>
                
                <h5>üìä Variable Results:</h5>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <tr style="background: #f0f0f0;">
                        <th style="padding: 8px; border: 1px solid #ddd;">Variable</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Data Points</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Output File</th>
                    </tr>
            `;
            
            Object.entries(data.results).forEach(([variable, result]) => {
                const status = result.error ? `‚ùå ${result.error}` : '‚úÖ Success';
                const points = result.n_points || 'N/A';
                const file = result.output_file || 'N/A';
                
                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${variable}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${points}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">${file}</td>
                    </tr>
                `;
            });
            
            html += `
                </table>
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                    <strong>üìÅ Output Location:</strong> All files have been saved to the <code>outputs/</code> directory.<br>
                    <strong>üìÑ File Format:</strong> GeoTIFF (.tif) files compatible with GIS software.
                </div>
            `;
            
            document.getElementById('result-content').innerHTML = html;
        }
    </script>
</body>
</html>