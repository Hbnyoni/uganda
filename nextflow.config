/*
========================================================================================
    CHEAQI Nextflow Configuration
========================================================================================
*/

// Global default params, used in configs
params {
    // Container settings
    enable_conda = true
    
    // Resource defaults
    max_cpus = 4
    max_memory = '8.GB'
    max_time = '4.h'
    
    // Input/Output settings
    input_dir = '/app/data'
    output_dir = '/app/outputs'
    scripts_dir = '/app/scripts'
    tracedir = "${params.output_dir}/pipeline_info"
    
    // CSV and processing parameters
    input_csv = null
    csv_pattern = '*.csv'
    variables = 'temperature,humidity,precipitation'
    lat_column = 'latitude'
    lon_column = 'longitude'
    method = 'kriging'
    resolution = 100
    cross_validation = true
    min_points = 10
    buffer_percent = 0.1
    validation_folds = 5
    
    // Output options
    output_format = 'geotiff'
    create_plots = true
    generate_report = true
    
    // Help
    help = false
}

// Configuration for CHEAQI workflow
// All settings are included in this file

profiles {
    
    conda {
        params.enable_conda = true
        conda.enabled = true
        conda.envPath = '/opt/conda/envs/cheaqi'
    }
    
    docker {
        docker.enabled = true
        docker.userEmulation = true
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        
        // Use current container
        process.container = 'cheaqi-docker-cheaqi-notebook'
    }
    
    test {
        params.input_dir = 'test_data'
        params.csv_pattern = 'test_*.csv'
        params.variables = 'test_var1,test_var2'
        params.resolution = 50
    }
    
    debug {
        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false
    }
}

// Export these variables to prevent local Python/R libraries from conflicting with bin
env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER = "/.Rprofile"
    R_ENVIRON_USER = "/.Renviron"
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file = "${params.tracedir}/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file = "${params.tracedir}/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file = "${params.tracedir}/execution_trace_${trace_timestamp}.txt"
}
dag {
    enabled = true
    file = "${params.tracedir}/pipeline_dag_${trace_timestamp}.svg"
}

manifest {
    name = 'CHEAQI-Spatial-Interpolation'
    author = 'CHEAQI Team'
    homePage = 'https://github.com/your-org/cheaqi-workflow'
    description = 'Spatial interpolation workflow for health facility data'
    mainScript = 'main.nf'
    nextflowVersion = '>=21.10.3'
    version = '1.0.0'
}